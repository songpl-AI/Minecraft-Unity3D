## Backend 整体架构图（路演版）

> 说明：你当前环境 Mermaid 渲染失败，因此这里用 **ASCII 分层图**，可直接复制到 PPT 或截图使用。

### 1) 分层总体架构（Backend + Sandbox）

```
┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                               AI Interactive Video                                           │
│                                                   Backend 架构图                                              │
├──────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ 展示层                                                                                                        │
│   ┌───────────────┐   ┌───────────────┐   ┌───────────────┐   ┌──────────────────┐                          │
│   │ Web Frontend   │   │ Mobile / H5   │   │ 大屏展示/路演  │   │ Swagger /docs    │                          │
│   └───────┬───────┘   └───────┬───────┘   └───────┬───────┘   └─────────┬────────┘                          │
│           │                   │                   │                     │                                   │
├───────────┴───────────────────┴───────────────────┴─────────────────────┴───────────────────────────────────┤
│ 接入与控制层                                                                                                   │
│   ┌────────────────────────────────────────────────────────────────────────────────────────────────────────┐ │
│   │ FastAPI App (backend/main.py)                                                                           │ │
│   │ - CORS                                                                                                  │ │
│   │ - 全局异常处理                                                                                           │ │
│   │ - 路由: auth / sessions / tasks / upload / preview / test                                                │ │
│   └────────────────────────────────────────────────────────────────────────────────────────────────────────┘ │
│     │                                                                                                         │
│     ├────────────── 鉴权与权限（横切） ──────────────┐            ┌────────────── 日志与Trace（横切） ───────┐ │
│     │                                                │            │                                          │ │
│     ▼                                                │            ▼                                          │ │
│  Auth Service                                        │         Logging / Trace Id / Metrics                 │ │
│                                                      │                                                      │ │
├──────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ Agent 层（多 Agent 调度 + 工作流）                                                                             │
│   ┌────────────────────────────┐    ┌─────────────────────────────┐    ┌──────────────────────────────────┐  │
│   │ StoryFlow / ManusChat       │    │ Plan-Act Flow               │    │ VideoGenService                  │  │
│   │ - 生成故事/标题/封面等      │    │ - 规划步骤 + 工具调用        │    │ - 启动/查询视频流水线             │  │
│   └──────────────┬─────────────┘    └───────────────┬─────────────┘    └───────────────┬──────────────────┘  │
│                  │                                   │                                  │                     │
│                  └───────────────┬───────────────────┴───────────────┬──────────────────┘                     │
│                                  ▼                                   ▼                                        │
│                    Super Agent Orchestrator (超级调度)         Prompt Library                                   │
│                    - 选择子 Agent                               - storyboard prompt                            │
│                    - 生成 Plan                                  - decision tree                               │
│                    - 执行 Act(工具调用)                           - 安全重写/对齐提示词                           │
│                    - 主模型 + 兜底模型                           - 角色/风格等                                 │
├──────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ 工具与执行层（Tooling）                                                                                         │
│   ┌───────────────────────────────┐   ┌───────────────────────────────┐   ┌───────────────────────────────┐  │
│   │ Gemini Image Client            │   │ APX Video Client               │   │ TTS Wrapper                    │  │
│   │ - 九宫格底图生成                │   │ - create_task + polling detail │   │ - 合成旁白音频                  │  │
│   └───────────────┬───────────────┘   └───────────────┬───────────────┘   └───────────────┬───────────────┘  │
│                   │                                   │                                   │                  │
│   ┌───────────────▼───────────────┐   ┌───────────────▼───────────────┐   ┌───────────────▼───────────────┐  │
│   │ Image Preprocess               │   │ Video Composer                 │   │ Uploader / OSS Utility         │  │
│   │ - slice_grid / resize_letterbox│   │ - 字幕 + 音频合成               │   │ - upload_bytes / put_object     │  │
│   └───────────────────────────────┘   └───────────────────────────────┘   └───────────────────────────────┘  │
│                                   ┌─────────────────────────────────────────────────────────────────────────┐ │
│                                   │ FFmpeg / FFprobe (本机依赖)                                               │ │
│                                   │ - 探测时长 / 合成 / concat                                                 │ │
│                                   └─────────────────────────────────────────────────────────────────────────┘ │
├──────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ Sandbox 子系统（生成游戏/项目文件/预览）                                                                        │
│   ┌────────────────────────────────────────────────────────────────────────────────────────────────────────┐ │
│   │ Sandbox Service (backend/sandbox)                                                                         │ │
│   │ - API 8081: 文件/项目管理（file_api / project_api）                                                       │ │
│   │ - Static 8082: 预览 Projects 输出                                                                         │ │
│   │ - Templates: frontend_template / smallgame                                                                 │ │
│   └────────────────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                     ▲                                                │                                        │
│                     │ SandboxClient 调用                              ▼                                        │
│                Plan-Act Flow ----------------------------------> Projects 输出目录（可 iframe 预览）            │
├──────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ 持久化与外部依赖                                                                                                 │
│   ┌────────────────────┐   ┌────────────────────┐   ┌───────────────────────────┐   ┌──────────────────────┐  │
│   │ SQLite              │   │ Redis (可选)        │   │ OSS 对象存储               │   │ 外部AI服务             │  │
│   │ - sessions / state  │   │ - task/queue        │   │ - 图片/视频/静态资源托管    │   │ - Gemini/APX/TTS/OpenAI │  │
│   └────────────────────┘   └────────────────────┘   └───────────────────────────┘   └──────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 2) 关键链路 A：视频生成流水线（pipeline_executor）

```
用户请求
  │
  ▼
create_and_run_pipeline -> PipelineJob
  │
  ▼
Stage1 Storyboard (Agent: 主模型失败则兜底模型)
  │  输出: 9 个 shots
  ▼
Stage2 Grid Image (Gemini 生图 -> download -> upload -> slice_grid -> upload tiles)
  │  输出: shot_image_url * 9
  ▼
Stage3 Video Shots 并发
  │  (对齐脚本 align_shot_with_image -> APX create_task -> polling detail -> on_video_done)
  │  错误: moderation_blocked -> 安全重写 -> 重试；普通错误 -> 延迟重试
  ▼
Stage4 合成
  │  每段: tts -> 字幕+旁白合成；失败则用静态图生成视频兜底
  ▼
ffmpeg concat -> upload final -> final_video_url
```

### 3) 关键链路 B：生成游戏/项目（超级 Agent + 子 Agent + Sandbox）

```
用户目标(生成小游戏/互动页面)
  │
  ▼
Plan-Act Flow (Agent 规划步骤)
  │
  ├─ 调用工具: 选择模板(frontend_template / smallgame)
  ├─ 调用工具: 生成/修改配置与代码(文件写入、资源拷贝、参数替换)
  ▼
SandboxClient -> Sandbox API (8081)
  │
  ├─ 创建项目目录
  ├─ 写入/更新文件
  └─ 输出到 Projects 目录
  ▼
Sandbox Static (8082) 提供预览
```


